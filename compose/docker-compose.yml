version: "4"
name: fullstackhero

services:
  webapi:
    image: ${FSH_DOTNETSTARTERKIT_WEBAPI_IMAGE}
    pull_policy: always
    container_name: webapi
    networks:
      - fullstackhero
    environment:
      ASPNETCORE_ENVIRONMENT: docker
      ASPNETCORE_URLS: https://+:7000;http://+:5000
      ASPNETCORE_HTTPS_PORT: 7000
      ASPNETCORE_Kestrel__Certificates__Default__Password: password!
      ASPNETCORE_Kestrel__Certificates__Default__Path: /https/cert.pfx
      DatabaseOptions__ConnectionString: Server=postgres;Port=5433;Database=fullstackhero;User Id=pgadmin;Password=pgadmin
      DatabaseOptions__Provider: postgresql
      JwtOptions__Key: QsJbczCNysv/5SGh+U7sxedX8C07TPQPBdsnSDKZ/aE=
      HangfireOptions__Username: admin
      HangfireOptions__Password: Secure1234!Me
      MailOptions__From: mukesh@fullstackhero.net
      MailOptions__Host: smtp.ethereal.email
      MailOptions__Port: 587
      MailOptions__UserName: sherman.oconnell47@ethereal.email
      MailOptions__Password: KbuTCFv4J6Fy7256vh
      MailOptions__DisplayName: Mukesh Murugan
      CorsOptions__AllowedOrigins__0: http://localhost:5010
      CorsOptions__AllowedOrigins__1: http://localhost:7100
      CorsOptions__AllowedOrigins__2: https://localhost:7020
      OpenTelemetryOptions__Endpoint: http://otel-collector:4317
      RateLimitOptions__EnableRateLimiting: false
    volumes:
      - ~/.aspnet/https:/https:ro
    ports:
      - 7000:7000
      - 5000:5000
    depends_on:
      postgres:
        condition: service_healthy
    restart: on-failure

  blazor:
    image: ${FSH_DOTNETSTARTERKIT_WEBAPI_IMAGE}
    pull_policy: always
    container_name: blazor
    environment:
      Frontend_FSHStarterBlazorClient_Settings__AppSettingsTemplate: /usr/share/nginx/html/appsettings.json.TEMPLATE
      Frontend_FSHStarterBlazorClient_Settings__AppSettingsJson: /usr/share/nginx/html/appsettings.json
      FSHStarterBlazorClient_ApiBaseUrl: https://localhost:7000
      ApiBaseUrl: https://localhost:7000
    networks:
      - fullstackhero
    entrypoint:
      [
        "/bin/sh",
        "-c",
        "envsubst <
          $${Frontend_FSHStarterBlazorClient_Settings__AppSettingsTemplate} >
          $${Frontend_FSHStarterBlazorClient_Settings__AppSettingsJson} && find
          /usr/share/nginx/html -type f | xargs chmod +r && exec nginx -g
          'daemon off;'"
      ]
    volumes:
      - ~/.aspnet/https:/https:ro
    ports:
      - 7100:80
    depends_on:
      postgres:
        condition: service_healthy
    restart: on-failure

  postgres:
    container_name: postgres
    image: postgres:15-alpine
    networks:
      - fullstackhero
    environment:
      POSTGRES_USER: pgadmin
      POSTGRES_PASSWORD: pgadmin
      PGPORT: 5433
    ports:
      - 5433:5433
    volumes:
      - $BASE_PATH/postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U pgadmin"]
      interval: 10s
      timeout: 5s
      retries: 5

  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    restart: unless-stopped
    networks:
      - fullstackhero
    volumes:
      - $BASE_PATH/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      - $BASE_PATH/prometheus-data:/prometheus
    ports:
      - 9090:9090

  grafana:
    container_name: grafana
    image: grafana/grafana:latest
    ports:
      - 3000:3000
    volumes:
      - $BASE_PATH/grafana-data:/var/lib/grafana
    depends_on:
      - prometheus
    restart: unless-stopped
    networks:
      - fullstackhero

  otel-collector:
    image: otel/opentelemetry-collector-contrib:latest
    container_name: otel-collector
    command: ["--config=/etc/otel/config.yaml"]
    volumes:
      - $BASE_PATH/otel-collector/otel-config.yaml:/etc/otel/config.yaml
      - $BASE_PATH/otel-collector/log:/log/otel
    ports:
      - 8888:8888     # Prometheus metrics exposed by the collector
      - 8889:8889     # Prometheus metrics exporter (scrape endpoint)
      - 13133:13133   # health_check extension
      - "55679:55679" # ZPages extension
      - 4317:4317     # OTLP gRPC receiver
    networks:
      - fullstackhero

  node_exporter:
    image: quay.io/prometheus/node-exporter:v1.5.0
    container_name: node_exporter
    command: "--path.rootfs=/host"
    pid: host
    restart: unless-stopped
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    networks:
      - fullstackhero

volumes:
  postgres-data:
  grafana-data:
  prometheus-data:

networks:
  fullstackhero:
